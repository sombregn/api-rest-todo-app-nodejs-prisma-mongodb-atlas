import { StatusCodes } from 'http-status-codes';
import todoListService from '../services/todoList.service.js';
import todoListMapper from '../mappers/todoList.mapper.js';
import todoItemMapper from '../mappers/todoItem.mapper.js';
import catchAsync from '../utils/catchAsync.js';
import responseFormatter from '../utils/responseFormatter.js';
import logger from '../utils/logger.js';

// ‚úÖ IMPORTS DES ERREURS ENRICHIES
import { NotFoundError, ConflictError } from '../utils/AppError.js';

class TodoListController {
  /**
   * GET /api/todolists
   * R√©cup√©rer toutes les listes avec filtres et pagination
   */
  getAllLists = catchAsync(async (req, res) => {
    const { status, limit, page, sortBy, order } = req.query;
    
    logger.info('üìã Getting all lists', { 
      requestId: req.requestId,
      filters: req.query,
      validatedQuery: { status, limit, page, sortBy, order }
    });
    
    const filters = {};
    if (status) filters.status = status;

    const lists = await todoListService.getAllLists(filters, {
      limit,
      page,
      sortBy,
      order
    }, req.requestId);

    const mappedLists = todoListMapper.toAPIList(lists.data);
    
    return responseFormatter.paginated(
      res,
      { lists: mappedLists },
      {
        page: lists.page,
        limit: lists.limit,
        total: lists.total
      },
      'Listes r√©cup√©r√©es avec succ√®s'
    );
  }, { controller: 'TodoListController', action: 'getAllLists' });

  /**
   * GET /api/todolists/recent
   * R√©cup√©rer les listes r√©cemment modifi√©es
   */
  getRecentLists = catchAsync(async (req, res) => {
    const { limit } = req.query;
    
    logger.info('üìã Getting recent lists', { 
      requestId: req.requestId,
      limit 
    });
    
    const lists = await todoListService.getRecentLists(limit, req.requestId);
    const mappedLists = lists.map(list => todoListMapper.toSummary(list));
    
    return responseFormatter.success(
      res,
      { lists: mappedLists },
      `${mappedLists.length} listes r√©centes r√©cup√©r√©es`
    );
  }, { controller: 'TodoListController', action: 'getRecentLists' });

  /**
   * GET /api/todolists/:id
   * R√©cup√©rer une liste par ID
   */
  getListById = catchAsync(async (req, res) => {
    const { id } = req.params;
    
    logger.info('üìã Fetching todo list', { 
      requestId: req.requestId,
      listId: id,
      userAgent: req.get('user-agent')
    });
    
    const list = await todoListService.getListById(id, req.requestId);
    
    if (!list) {
      throw new NotFoundError('Liste TODO')
        .addContext('listId', id)
        .addContext('action', 'getListById')
        .addContext('requestId', req.requestId)
        .addHint('V√©rifiez que l\'ID fourni est correct')
        .addHint('Consultez GET /api/todolists pour voir les listes disponibles')
        .addHint('L\'ID doit √™tre un ObjectID MongoDB valide');
    }
    
    const mappedList = todoListMapper.toAPI(list);
    
    logger.info('‚úÖ Todo list retrieved successfully', { 
      requestId: req.requestId,
      listId: id,
      itemCount: list.items?.length || 0
    });
    
    return responseFormatter.success(
      res,
      { list: mappedList },
      'Liste r√©cup√©r√©e avec succ√®s'
    );
  }, { controller: 'TodoListController', action: 'getListById' });

  /**
   * GET /api/todolists/by-name/:name
   * R√©cup√©rer une liste par nom
   */
  getListByName = catchAsync(async (req, res) => {
    const { name } = req.params;
    
    logger.info('üìã Getting list by name', { 
      requestId: req.requestId,
      name 
    });
    
    try {
      const list = await todoListService.getListByName(name, req.requestId);
      const mappedList = todoListMapper.toAPI(list);
      
      return responseFormatter.success(
        res,
        { list: mappedList },
        'Liste trouv√©e'
      );
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addContext('searchName', name)
             .addContext('action', 'getListByName')
             .addHint('V√©rifiez l\'orthographe du nom')
             .addHint('La recherche est insensible √† la casse')
             .addHint('Consultez GET /api/todolists pour voir les noms disponibles');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'getListByName' });

  /**
   * POST /api/todolists
   * Cr√©er une nouvelle liste
   */
  createList = catchAsync(async (req, res) => {
    logger.info('üÜï Creating new todo list', { 
      requestId: req.requestId,
      title: req.body.title,
      dataSize: JSON.stringify(req.body).length
    });
    
    try {
      const dbData = todoListMapper.toDBCreate(req.body);
      const list = await todoListService.createList(dbData, req.requestId);
      const mappedList = todoListMapper.toAPI(list);
      
      logger.info('‚úÖ Todo list created successfully', { 
        requestId: req.requestId,
        listId: list.id,
        title: list.title
      });
      
      return responseFormatter.created(
        res,
        { list: mappedList },
        'Liste cr√©√©e avec succ√®s'
      );
    } catch (error) {
      if (error.addContext) {
        error.addContext('operation', 'createList')
             .addContext('inputData', req.body)
             .addContext('dataValidation', 'passed')
             .addContext('requestId', req.requestId);
      }
      
      if (error instanceof ConflictError) {
        error.addHint('Modifiez le titre de votre liste')
             .addHint('Ou mettez √† jour la liste existante avec PUT /api/todolists/:id')
             .addHint('Les titres doivent √™tre uniques (insensible √† la casse)');
      }
      
      throw error;
    }
  }, { controller: 'TodoListController', action: 'createList' });

  /**
   * PUT /api/todolists/:id
   * Mettre √† jour compl√®tement une liste
   */
  updateList = catchAsync(async (req, res) => {
    const { id } = req.params;
    
    logger.info('üîÑ Updating list', { 
      requestId: req.requestId,
      id, 
      data: req.body,
      validation: 'passed'
    });
    
    try {
      const dbData = todoListMapper.toDBUpdate(req.body);
      const list = await todoListService.updateList(id, dbData, req.requestId);
      
      if (!list) {
        throw new NotFoundError('Liste TODO')
          .addContext('listId', id)
          .addContext('operation', 'update')
          .addContext('requestId', req.requestId)
          .addHint('V√©rifiez que l\'ID existe avec GET /api/todolists/:id')
          .addHint('La liste a peut-√™tre √©t√© supprim√©e');
      }
      
      const mappedList = todoListMapper.toAPI(list);
      
      logger.info('‚úÖ List updated successfully', { 
        requestId: req.requestId,
        id 
      });
      
      return responseFormatter.updated(
        res,
        { list: mappedList },
        'Liste mise √† jour avec succ√®s'
      );
    } catch (error) {
      if (error instanceof ConflictError) {
        error.addHint('Un autre √©l√©ment utilise d√©j√† ce titre')
             .addHint('Choisissez un titre diff√©rent');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'updateList' });

  /**
   * PATCH /api/todolists/:id
   * Mettre √† jour partiellement une liste
   */
  patchList = catchAsync(async (req, res) => {
    const { id } = req.params;
    
    logger.info('üîÑ Patching list', { 
      requestId: req.requestId,
      id, 
      data: req.body,
      fieldsCount: Object.keys(req.body).length
    });
    
    try {
      const dbData = todoListMapper.toDBUpdate(req.body);
      const list = await todoListService.updateList(id, dbData, req.requestId);
      
      if (!list) {
        throw new NotFoundError('Liste TODO')
          .addContext('listId', id)
          .addContext('operation', 'patch')
          .addContext('fieldsUpdated', Object.keys(req.body))
          .addContext('requestId', req.requestId)
          .addHint('V√©rifiez que l\'ID existe')
          .addHint('Pour une cr√©ation, utilisez POST /api/todolists');
      }
      
      const mappedList = todoListMapper.toAPI(list);
      
      logger.info('‚úÖ List patched successfully', { 
        requestId: req.requestId,
        id 
      });
      
      return responseFormatter.updated(
        res,
        { list: mappedList },
        'Liste mise √† jour avec succ√®s'
      );
    } catch (error) {
      if (error instanceof ConflictError) {
        error.addHint('Conflit d√©tect√© sur un champ modifi√©')
             .addHint('V√©rifiez les donn√©es existantes');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'patchList' });

  /**
   * DELETE /api/todolists/:id
   * Supprimer une liste
   */
  deleteList = catchAsync(async (req, res) => {
    const { id } = req.params;
    
    logger.info('üóëÔ∏è Deleting todo list', { 
      requestId: req.requestId,
      listId: id
    });
    
    try {
      const deleted = await todoListService.deleteList(id, req.requestId);
      
      if (!deleted) {
        throw new NotFoundError('Liste TODO')
          .addContext('listId', id)
          .addContext('operation', 'delete')
          .addContext('requestId', req.requestId)
          .addHint('La liste a peut-√™tre d√©j√† √©t√© supprim√©e')
          .addHint('V√©rifiez que l\'ID existe avec GET /api/todolists/:id')
          .addHint('Utilisez GET /api/todolists pour voir les listes disponibles');
      }
      
      logger.info('‚úÖ Todo list deleted successfully', { 
        requestId: req.requestId,
        listId: id
      });
      
      return responseFormatter.deleted(res, 'Liste supprim√©e avec succ√®s');
    } catch (error) {
      logger.error('‚ùå Error deleting todo list', {
        requestId: req.requestId,
        listId: id,
        error: error.message,
        stack: error.stack?.split('\n')[0]
      });
      
      if (error instanceof NotFoundError) {
        error.addHint('Impossible de supprimer une liste inexistante');
      }
      
      throw error;
    }
  }, { controller: 'TodoListController', action: 'deleteList' });

  /**
   * POST /api/todolists/:listId/items
   * Ajouter un item √† une liste
   */
  addItem = catchAsync(async (req, res) => {
    const { listId } = req.params;
    
    logger.info('‚ûï Adding item to list', { 
      requestId: req.requestId,
      listId, 
      data: req.body,
      validation: 'passed'
    });
    
    try {
      const dbData = todoItemMapper.toDBCreate(req.body, listId);
      const item = await todoListService.addItemToList(listId, dbData, req.requestId);
      const mappedItem = todoItemMapper.toAPI(item);
      
      logger.info('‚úÖ Item added successfully', { 
        requestId: req.requestId,
        listId, 
        itemId: item.id 
      });
      
      return responseFormatter.created(
        res,
        { item: mappedItem },
        'Item ajout√© avec succ√®s'
      );
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addContext('operation', 'addItem')
             .addContext('targetListId', listId)
             .addHint('V√©rifiez que la liste parente existe')
             .addHint('Cr√©ez d\'abord la liste avec POST /api/todolists');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'addItem' });

  /**
   * PUT /api/todolists/:listId/items/:itemId
   * Mettre √† jour compl√®tement un item
   */
  updateItem = catchAsync(async (req, res) => {
    const { listId, itemId } = req.params;
    
    logger.info('üîÑ Updating item', { 
      requestId: req.requestId,
      listId, 
      itemId, 
      data: req.body,
      validation: 'passed'
    });
    
    try {
      const dbData = todoItemMapper.toDBUpdate(req.body);
      const item = await todoListService.updateItem(listId, itemId, dbData, req.requestId);
      
      if (!item) {
        throw new NotFoundError('Item')
          .addContext('listId', listId)
          .addContext('itemId', itemId)
          .addContext('operation', 'updateItem')
          .addHint('V√©rifiez que l\'item et la liste existent')
          .addHint('V√©rifiez que l\'item appartient √† cette liste');
      }
      
      const mappedItem = todoItemMapper.toAPI(item);
      
      logger.info('‚úÖ Item updated successfully', { 
        requestId: req.requestId,
        listId, 
        itemId 
      });
      
      return responseFormatter.updated(
        res,
        { item: mappedItem },
        'Item mis √† jour avec succ√®s'
      );
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addHint('L\'item n\'existe pas ou n\'appartient pas √† cette liste');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'updateItem' });

  /**
   * PATCH /api/todolists/:listId/items/:itemId
   * Mettre √† jour partiellement un item
   */
  patchItem = catchAsync(async (req, res) => {
    const { listId, itemId } = req.params;
    
    logger.info('üîÑ Patching item', { 
      requestId: req.requestId,
      listId, 
      itemId, 
      data: req.body,
      fieldsCount: Object.keys(req.body).length
    });
    
    try {
      const dbData = todoItemMapper.toDBUpdate(req.body);
      const item = await todoListService.updateItem(listId, itemId, dbData, req.requestId);
      
      if (!item) {
        throw new NotFoundError('Item')
          .addContext('listId', listId)
          .addContext('itemId', itemId)
          .addContext('operation', 'patchItem')
          .addContext('fieldsUpdated', Object.keys(req.body))
          .addHint('V√©rifiez que l\'item et la liste existent')
          .addHint('V√©rifiez que l\'item appartient √† cette liste');
      }
      
      const mappedItem = todoItemMapper.toAPI(item);
      
      logger.info('‚úÖ Item patched successfully', { 
        requestId: req.requestId,
        listId, 
        itemId 
      });
      
      return responseFormatter.updated(
        res,
        { item: mappedItem },
        'Item mis √† jour avec succ√®s'
      );
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addHint('L\'item n\'existe pas dans cette liste');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'patchItem' });

  /**
   * DELETE /api/todolists/:listId/items/:itemId
   * Supprimer un item d'une liste
   */
  removeItem = catchAsync(async (req, res) => {
    const { listId, itemId } = req.params;
    
    logger.info('üóëÔ∏è Removing item from list', { 
      requestId: req.requestId,
      listId, 
      itemId 
    });
    
    try {
      const deleted = await todoListService.removeItemFromList(listId, itemId, req.requestId);
      
      if (!deleted) {
        throw new NotFoundError('Item')
          .addContext('listId', listId)
          .addContext('itemId', itemId)
          .addContext('operation', 'removeItem')
          .addHint('L\'item a peut-√™tre d√©j√† √©t√© supprim√©')
          .addHint('V√©rifiez que l\'item appartient √† cette liste');
      }
      
      logger.info('‚úÖ Item removed successfully', { 
        requestId: req.requestId,
        listId, 
        itemId 
      });
      
      return responseFormatter.deleted(res, 'Item supprim√© avec succ√®s');
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addHint('Impossible de supprimer un item inexistant');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'removeItem' });

  /**
   * PATCH /api/todolists/:listId/items/:itemId/toggle
   * Basculer le statut d'un item
   */
  toggleItemStatus = catchAsync(async (req, res) => {
    const { listId, itemId } = req.params;
    
    logger.info('üîÑ Toggling item status', { 
      requestId: req.requestId,
      listId, 
      itemId 
    });
    
    try {
      const item = await todoListService.toggleItemStatus(listId, itemId, req.requestId);
      
      if (!item) {
        throw new NotFoundError('Item')
          .addContext('listId', listId)
          .addContext('itemId', itemId)
          .addContext('operation', 'toggleStatus')
          .addHint('V√©rifiez que l\'item existe dans cette liste')
          .addHint('Utilisez GET /api/todolists/:id pour voir les items');
      }
      
      const mappedItem = todoItemMapper.toAPI(item);
      
      logger.info('‚úÖ Item status toggled', { 
        requestId: req.requestId,
        listId, 
        itemId, 
        newStatus: item.status 
      });
      
      return responseFormatter.updated(
        res,
        { item: mappedItem },
        `Item marqu√© comme ${item.status === 'COMPLETED' ? 'termin√©' : 'non termin√©'}`
      );
    } catch (error) {
      if (error instanceof NotFoundError) {
        error.addHint('L\'item n\'existe pas dans cette liste');
      }
      throw error;
    }
  }, { controller: 'TodoListController', action: 'toggleItemStatus' });
}

// ‚úÖ EXPORT CORRECT
export default new TodoListController();